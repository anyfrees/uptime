# .github/workflows/build-and-publish.yml

name: Build and 拨测客户端

on:
  push:
    branches: [ main ] 
  release:
    types: [published] 

jobs:
  build-and-release:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18.x 

    - name: Install dependencies (npm)
      run: npm ci 

    # 新增：为 Linux 构建安装必要的依赖
    - name: Install Linux build dependencies
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y dpkg fakeroot rpm # rpmbuild 通常随 rpm 包一起安装

    - name: Build application
      id: build_app 
      run: npm run dist 
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # CSC_LINK: ${{ secrets.CSC_LINK }} 
        # CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }} 

    - name: Upload Windows Artifact (Installer)
      if: matrix.os == 'windows-latest' && success()
      uses: actions/upload-artifact@v4
      with:
        name: 主动可用性拨测平台客户端-Windows-Installer-${{ github.sha }}
        path: dist/*Setup*.exe 

    - name: Upload Windows Artifact (Portable)
      if: matrix.os == 'windows-latest' && success()
      uses: actions/upload-artifact@v4
      with:
        name: 主动可用性拨测平台客户端-Windows-Portable-${{ github.sha }}
        path: dist/*portable*.exe 

    - name: Upload macOS Artifact (DMG)
      if: matrix.os == 'macos-latest' && success()
      uses: actions/upload-artifact@v4
      with:
        name: 主动可用性拨测平台客户端-macOS-${{ github.sha }}
        path: dist/*.dmg

    - name: Upload macOS Artifact (ZIP)
      if: matrix.os == 'macos-latest' && success()
      uses: actions/upload-artifact@v4
      with:
        name: 主动可用性拨测平台客户端-macOS-zip-${{ github.sha }}
        path: dist/*.zip # 假设您的 mac target 也包含 zip

    - name: Upload Linux Artifact (AppImage)
      if: matrix.os == 'ubuntu-latest' && success()
      uses: actions/upload-artifact@v4
      with:
        name: 主动可用性拨测平台客户端-Linux-AppImage-${{ github.sha }}
        path: dist/*.AppImage

    - name: Upload Linux Artifact (deb)
      if: matrix.os == 'ubuntu-latest' && success()
      uses: actions/upload-artifact@v4
      with:
        name: 主动可用性拨测平台客户端-Linux-deb-${{ github.sha }}
        path: dist/*.deb
        
    - name: Upload Linux Artifact (rpm)
      if: matrix.os == 'ubuntu-latest' && success()
      uses: actions/upload-artifact@v4
      with:
        name: 主动可用性拨测平台客户端-Linux-rpm-${{ github.sha }}
        path: dist/*.rpm
